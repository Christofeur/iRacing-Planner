<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ascendia Racing ‚Äî Endurance Planner</title>
<link rel="stylesheet" href="ascendia.css">
</head>

<body>

<header class="topbar">
  <div class="logo">
    <img src="logo.png" alt="Ascendia Racing">
    <span>Ascendia Racing ‚Äî Endurance Planner</span>
  </div>
  <div class="nav">
    <a href="index.html" class="btn">üè† Accueil</a>
    <a href="live.html" class="btn">üü¢ Live</a>
    <a href="export.html" class="btn danger">üì§ Export</a>
  </div>
</header>

<div class="smoke"></div>

<main class="container">

  <aside class="leftPanel">

    <div class="card" id="sofBox">üèÅ SOF √©quipe : -</div>

    <div class="card">
      <h3>Nom du planning</h3>
      <input id="planName" placeholder="Ex: Spa 24h - Ascendia">
    </div>

    <div class="card">
      <h3>Pilotes</h3>
      Nom: <input id="driverName">
      iR: <input id="driverIR" type="number" value="1500">
      <button onclick="addDriver()">+ Ajouter</button>
      <div id="drivers"></div>
    </div>

    <div class="card">
      <h3>Course</h3>
      Heure d√©part: <input id="startTime" type="time" value="14:00"><br>
      Dur√©e (h): <input id="raceHours" type="number" value="6"><br>
      Type relais:
      <select id="stintMode">
        <option value="simple">Simple</option>
        <option value="double">Double</option>
      </select>
    </div>

    <div class="card">
      <h3>Voiture / Carburant</h3>
      Capacit√© r√©servoir (L): <input id="fuelCap" type="number" value="120"><br>
      Conso par tour (L): <input id="fuelLap" type="number" step="0.01" value="3.2"><br>
      Temps au tour (mm:ss): <input id="lapTime" value="01:45"><br>
      Temps pit (sec): <input id="pitSec" type="number" value="40">
    </div>

    <div class="card">
      <button onclick="generatePlan()">üßÆ G√©n√©rer le planning</button>
      <button onclick="savePlan()">üíæ Sauvegarder</button><br><br>

      <select id="loadSelect"></select><br>
      <button onclick="loadSelectedPlan()">üìÇ Charger</button>
      <button onclick="deleteSelectedPlan()">üóëÔ∏è Supprimer</button>
    </div>

    <div class="card" id="checks"></div>

  </aside>

  <section class="mainPanel">

    <div id="ruleBanner" class="ruleBanner"></div>

    <div class="card">
      <h3>Planning</h3>
      <table>
        <thead>
          <tr>
            <th>D√©but</th>
            <th>Fin</th>
            <th>Pilote</th>
            <th>Tours</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="planTable"></tbody>
      </table>
    </div>

  </section>

</main>

<script>
let state = { name:"", drivers:[], plan:[] };
let editIndex=null;

function $(id){ return document.getElementById(id); }

// ---------- SOF ----------
function updateSOF(){
  let box = $("sofBox");
  if(state.drivers.length === 0){
    box.textContent = "üèÅ SOF √©quipe : -";
    return;
  }
  let sum = 0;
  state.drivers.forEach(d => sum += (d.ir || 0));
  let sof = Math.round(sum / state.drivers.length);
  box.textContent = "üèÅ SOF √©quipe : " + sof;
}

// ---------- Temps ----------
function parseHM(t){ let [h,m]=t.split(":").map(Number); return h*3600+m*60; }
function fmt(sec){
  sec=((sec%86400)+86400)%86400;
  let h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

// ---------- Pilotes ----------
function addDriver(){
  let n=$("driverName").value.trim();
  let ir=+$("driverIR").value;
  if(!n) return;
  if(!ir || ir<0) ir=0;
  state.drivers.push({name:n, ir:ir, unavail:[]});
  $("driverName").value="";
  renderDrivers();
  updateSOF();
}

function renderDrivers(){
  let d=$("drivers"); d.innerHTML="";
  state.drivers.forEach((p,i)=>{
    let div=document.createElement("div");
    div.className="block";
    div.innerHTML=`<b>${p.name}</b> ‚Äî iR:
      <input type="number" value="${p.ir}" style="width:80px"
        onchange="state.drivers[${i}].ir = +this.value; updateSOF();">
      <button onclick="state.drivers.splice(${i},1);renderDrivers();updateSOF()">‚ùå</button>
      <button onclick="state.drivers[${i}].unavail.push({from:'00:00',to:'00:00'});renderDrivers()">+ Indispo</button>`;
    p.unavail.forEach((u,j)=>{
      div.innerHTML+=`<br>De <input type="time" value="${u.from}"
        onchange="state.drivers[${i}].unavail[${j}].from=this.value">
        √† <input type="time" value="${u.to}"
        onchange="state.drivers[${i}].unavail[${j}].to=this.value">
        <button onclick="state.drivers[${i}].unavail.splice(${j},1);renderDrivers()">‚ùå</button>`;
    });
    d.appendChild(div);
  });
}

// ---------- Disponibilit√© ----------
function isAvailable(driver,s,e){
  for(let u of driver.unavail){
    let a=parseHM(u.from), b=parseHM(u.to);
    let ss=s, ee=e; if(ee<ss) ee+=86400;
    let ranges=[];
    if(a<b){ranges.push([a,b]);ranges.push([a+86400,b+86400]);}
    else if(a>b){ranges.push([a,b+86400]);}
    else return false;
    for(let r of ranges){ if(ss<r[1] && r[0]<ee) return false; }
  }
  return true;
}

// ---------- Outils r√®gle ----------
function computeRuleStatus(){
  let count={}; state.drivers.forEach(d=>count[d.name]=0);
  state.plan.forEach(r=>count[r.driver]+=r.laps);

  let raceHours=+$("raceHours").value;
  let [lm,ls]=$("lapTime").value.split(":").map(Number);
  let lapSec=lm*60+ls;
  let total=Math.floor((raceHours*3600)/lapSec);
  let min=Math.floor(total/state.drivers.length/4);

  return { count, min };
}

// ---------- G√©n√©ration ----------
function generatePlan(){
  if(state.drivers.length===0) return alert("Ajoute des pilotes");

  let start=parseHM($("startTime").value);
  let raceHours=+$("raceHours").value;
  let fuelCap=+$("fuelCap").value;
  let fuelLap=+$("fuelLap").value;
  let [lm,ls]=$("lapTime").value.split(":").map(Number);
  let lapSec=lm*60+ls;
  let pitSec=+$("pitSec").value;

  let laps=Math.floor(fuelCap/fuelLap);
  let stintSec=laps*lapSec;
  $("info").textContent=`Relais = ${laps} tours ‚âà ${Math.round(stintSec/60)} min`;

  state.plan=[];
  let t=start, elapsed=0, idx=0, first=true;

  while(elapsed<raceHours*3600-1){
    if(!first){t+=pitSec; elapsed+=pitSec;}
    first=false;

    let found=null, tries=0;
    while(tries<state.drivers.length){
      let p=state.drivers[idx];
      if(isAvailable(p,t,t+stintSec)){found=p; break;}
      idx=(idx+1)%state.drivers.length; tries++;
    }
    if(!found) return alert("Aucun pilote disponible √† "+fmt(t));

    let rep=$("stintMode").value==="double"?2:1;
    for(let r=0;r<rep;r++){
      if(elapsed>=raceHours*3600) break;
      let startRel = t;
let endRel = t + stintSec;

// Si on d√©passe la fin de course, on coupe le relais
let maxEnd = start + raceHours * 3600;
if(endRel > maxEnd) endRel = maxEnd;

// Dur√©e r√©elle du relais
let realDuration = endRel - startRel;

// Tours r√©els possibles dans ce relais
let realLaps = Math.floor(realDuration / lapSec);

// S√©curit√©
if(realLaps < 0) realLaps = 0;

state.plan.push({
  start: startRel,
  end: endRel,
  driver: found.name,
  laps: realLaps
});

// Avance le temps
t = endRel;
elapsed += realDuration;

// Ajoute le pit seulement si ce n'est pas la fin de course
if(t < maxEnd && r < rep-1){
  t += pitSec;
  elapsed += pitSec;
}

      
      
    }
    idx=(idx+1)%state.drivers.length;
  }
// üîß Patch: forcer la fin de course √† l'heure officielle (sans toucher au reste)
    let officialEnd = start + raceHours * 3600;
      if(state.plan.length > 0){
      state.plan[state.plan.length - 1].end = officialEnd;
}

  updateAll();
}

// ---------- Affichage ----------
function renderPlan(){
  let tb=$("planTable"); tb.innerHTML="";
  let rule = computeRuleStatus();

  state.plan.forEach((r,i)=>{
    let tr=document.createElement("tr");
    let p=state.drivers.find(d=>d.name===r.driver);
    if(p && !isAvailable(p,r.start,r.end)) tr.classList.add("bad");

    let isBad = rule.count[r.driver] < rule.min;

    tr.innerHTML=`
      <td>${fmt(r.start)}</td>
      <td>${fmt(r.end)}</td>
      <td>${r.driver} ${isBad ? '<span class="warnIcon">‚ö†Ô∏è</span>' : ''}</td>
      <td>${r.laps}</td>
      <td><button onclick="openEdit(${i})">üîÅ</button></td>`;
    tb.appendChild(tr);
  });
}

// ---------- Edition ----------
function openEdit(i){
  editIndex=i;
  let sel=$("editSelect"); sel.innerHTML="";
  state.drivers.forEach(d=>{
    let o=document.createElement("option");
    o.value=d.name; o.textContent=d.name; sel.appendChild(o);
  });
  sel.value=state.plan[i].driver;
  $("editPopup").style.display="flex";
}
function closeEdit(){ $("editPopup").style.display="none"; }
function confirmEdit(){
  let name=$("editSelect").value;
  let stint=state.plan[editIndex];
  let d=state.drivers.find(x=>x.name===name);
  if(!isAvailable(d,stint.start,stint.end)){
    if(!confirm("‚ö†Ô∏è Pilote indisponible. Forcer ?")) return;
  }
  stint.driver=name;
  closeEdit();
  updateAll();
}

// ---------- R√®gle + Bandeau + Popup ----------
function checkRules(){
  let c=$("checks"); c.innerHTML="";
  let rule = computeRuleStatus();

  c.innerHTML=`<b>Minimum requis: ${rule.min} tours</b><br>`;
  state.drivers.forEach(d=>{
    let ok=rule.count[d.name]>=rule.min;
    let div=document.createElement("div");
    div.textContent=`${d.name} : ${rule.count[d.name]} tours`;
    div.style.color=ok?"lightgreen":"red";
    c.appendChild(div);
  });
}

function notifyIfRuleBroken(){
  let rule = computeRuleStatus();
  let bad = state.drivers.filter(d=>rule.count[d.name] < rule.min);
  let banner=$("ruleBanner");

  if(bad.length){
    let msg="‚ö†Ô∏è R√®gle iRacing non respect√©e par : "+bad.map(d=>d.name).join(", ");
    banner.textContent=msg;
    banner.style.display="block";
    alert("‚ö†Ô∏è R√®gle iRacing non respect√©e par :\n\n"+bad.map(d=>"- "+d.name).join("\n"));
  } else {
    banner.style.display="none";
    banner.textContent="";
  }
}

// ---------- Mise √† jour globale ----------
function updateAll(){
  renderPlan();
  checkRules();
  notifyIfRuleBroken();
}

// ---------- Sauvegarde / Chargement / Suppression ----------
function savePlan(){
  let name=$("planName").value.trim();
  if(!name) return alert("Donne un nom au planning");
  state.name=name;

  let data={state,form:{
    startTime:$("startTime").value,
    raceHours:$("raceHours").value,
    stintMode:$("stintMode").value,
    fuelCap:$("fuelCap").value,
    fuelLap:$("fuelLap").value,
    lapTime:$("lapTime").value,
    pitSec:$("pitSec").value
  }};
  localStorage.setItem("iracing_plan_"+name,JSON.stringify(data));
  refreshLoadList();
  alert("Sauvegarde OK");
}

function refreshLoadList(){
  let sel=$("loadSelect"); sel.innerHTML="";
  Object.keys(localStorage).filter(k=>k.startsWith("iracing_plan_")).forEach(k=>{
    let n=k.replace("iracing_plan_","");
    let o=document.createElement("option");
    o.value=n; o.textContent=n; sel.appendChild(o);
  });
}

function loadSelectedPlan(){
  let n=$("loadSelect").value;
  if(!n) return alert("Aucune sauvegarde s√©lectionn√©e");
  let data=JSON.parse(localStorage.getItem("iracing_plan_"+n));
  state=data.state;
  $("planName").value=state.name;
  Object.entries(data.form).forEach(([k,v])=>$(k).value=v);
  renderDrivers();
  updateSOF();
  updateAll();
}

function deleteSelectedPlan(){
  let n=$("loadSelect").value;
  if(!n) return alert("Aucune sauvegarde s√©lectionn√©e");
  if(confirm("Supprimer \""+n+"\" ?")){
    localStorage.removeItem("iracing_plan_"+n);
    refreshLoadList();
  }
}

// init
refreshLoadList();
updateSOF();
</script>

</body>
</html>















