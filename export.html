<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ascendia Racing - Export Planning</title>

<link rel="stylesheet" href="ascendia.css">

<!-- html2canvas (local ou CDN selon ton setup) -->
<script src="html2canvas.min.js"></script>

<style>
/* =========================
   EXPORT PNG STYLING
========================= */

#exportArea {
  background: linear-gradient(180deg, #0b1220, #05080f);
  padding: 30px;
  border-radius: 16px;
  border: 1px solid rgba(0,180,255,0.4);
  box-shadow: 0 0 40px rgba(0,0,0,0.8);
}

/* Header */
.exportHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.exportBrand {
  display: flex;
  align-items: center;
  gap: 15px;
}

.exportLogo {
  height: 60px;
}

.exportTeam {
  font-size: 26px;
  font-weight: bold;
  color: #7fe9ff;
  text-shadow: 0 0 10px rgba(0,180,255,0.5);
}

/* Title centered */
.exportMainTitle {
  text-align: center;
  font-size: 28px;
  color: #aeefff;
  margin: 10px 0 10px 0;
}

/* Info line */
.exportInfos {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 16px;
  color: #ccefff;
}

/* Rule box */
.exportRule {
  text-align: center;
  margin-bottom: 15px;
  padding: 10px;
  border-radius: 10px;
  background: linear-gradient(180deg, #0f1a2e, #0a1020);
  border: 1px solid rgba(0,150,255,0.3);
  color: #7fe9ff;
  font-weight: bold;
}

/* Tables */
#exportArea table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}

#exportArea th {
  background: linear-gradient(180deg, #1b6f8f, #0e3a4d);
  color: #e6f7ff;
  padding: 10px;
}

#exportArea td {
  padding: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.15);
  text-align: center;
}

#exportArea tr:nth-child(even) {
  background: rgba(255,255,255,0.04);
}

/* Recap */
.recapTitle {
  text-align: center;
  font-size: 20px;
  color: #7fe9ff;
  margin: 10px 0;
}
</style>

</head>
<body>

<!-- ================= TOP BAR ================= -->
<div id="topBar">
  <div class="teamBrand">
    <img src="logo.png" alt="Ascendia Racing" class="teamLogo">
    <span class="teamName">Ascendia Racing</span>
  </div>
</div>

<!-- ================= TOP NAV ================= -->
<div class="topNav">
  <button onclick="location.href='index.html'">üè† Accueil</button>
  <button onclick="location.href='planner.html'">üõ† Planner</button>
  <button onclick="location.href='live.html'">üü¢ Live</button>
</div>

<h1 class="mainTitle">üì§ Export du planning</h1>

<!-- ================= LAYOUT ================= -->
<div class="appContainer">

  <!-- ===== LEFT PANEL ===== -->
  <div id="leftPanel">

    <div class="block">
      <h2>Charger un planning</h2>
      <select id="loadSelect"></select><br><br>
      <button onclick="loadPlan()">üìÇ Charger</button>
    </div>

    <div class="block">
      <h2>Export</h2>
      <button id="exportBtn" onclick="exportPNG()" disabled>üì∏ Exporter en PNG</button>
    </div>

  </div>

  <!-- ===== RIGHT PANEL ===== -->
  <div id="rightPanel">

    <!-- ===== ZONE CAPTURE ===== -->
    <div id="exportArea">

      <div class="exportHeader">
        <div class="exportBrand">
          <img src="logo.png" class="exportLogo">
          <div class="exportTeam">Ascendia Racing</div>
        </div>
      </div>

      <div class="exportMainTitle" id="exportTitle">Planning</div>

      <div class="exportInfos">
        <div id="exportSOF">SOF : -</div>
        <div id="exportRaceName">-</div>
      </div>

      <div class="exportRule" id="exportRuleBox">
        R√®gle iRacing : -
      </div>

      <!-- ===== TABLE PLANNING ===== -->
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>D√©but</th>
            <th>Fin</th>
            <th>Pilote</th>
            <th>Tours</th>
          </tr>
        </thead>
        <tbody id="planTable"></tbody>
      </table>

      <!-- ===== RECAP ===== -->
      <div class="recapTitle">R√©capitulatif des tours par pilote</div>

      <table>
        <thead>
          <tr>
            <th>Pilote</th>
            <th>Total tours</th>
          </tr>
        </thead>
        <tbody id="recapTable"></tbody>
      </table>

    </div>

  </div>

</div>

<!-- ================= SCRIPT ================= -->
<script>
function $(id){ return document.getElementById(id); }

// -------- Temps --------
function fmt(sec){
  sec=((sec%86400)+86400)%86400;
  let h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

// -------- Charger la liste --------
function refreshLoadList(){
  let sel=$("loadSelect"); 
  sel.innerHTML="";
  Object.keys(localStorage)
    .filter(k=>k.startsWith("iracing_plan_"))
    .forEach(k=>{
      let n=k.replace("iracing_plan_","");
      let o=document.createElement("option");
      o.value=n; 
      o.textContent=n;
      sel.appendChild(o);
    });
}

// -------- Donn√©es --------
let currentPlan = null;
let currentData = null;

// -------- Charger un planning --------
function loadPlan(){
  let n = $("loadSelect").value;
  if(!n) return alert("Aucune sauvegarde s√©lectionn√©e");

  let raw = localStorage.getItem("iracing_plan_"+n);
  if(!raw) return alert("Sauvegarde introuvable");

  let data = JSON.parse(raw);
  currentData = data;
  currentPlan = data.state.plan;

  // Titre
  $("exportTitle").textContent = "Planning : " + n;
  $("exportRaceName").textContent = n;

  // SOF
  let sum = 0;
  data.state.drivers.forEach(d => sum += (d.ir || 0));
  let sof = Math.round(sum / data.state.drivers.length);
  $("exportSOF").textContent = "SOF : " + sof;

  // R√®gle iRacing
  let raceHours = +data.form.raceHours;
  let [lm,ls] = data.form.lapTime.split(":").map(Number);
  let lapSec = lm*60+ls;
  let total = Math.floor((raceHours*3600)/lapSec);
  let min = Math.floor(total/data.state.drivers.length/4);

  $("exportRuleBox").textContent = "R√®gle iRacing : minimum " + min + " tours par pilote";

  renderPlan();
  renderRecap();

  $("exportBtn").disabled = false;
}

// -------- Affichage planning --------
function renderPlan(){
  let tb = $("planTable");
  tb.innerHTML = "";

  currentPlan.forEach((r,i)=>{
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${fmt(r.start)}</td>
      <td>${fmt(r.end)}</td>
      <td>${r.driver}</td>
      <td>${r.laps}</td>
    `;
    tb.appendChild(tr);
  });
}

// -------- R√©cap pilotes --------
function renderRecap(){
  let recap = {};
  currentData.state.drivers.forEach(d => recap[d.name] = 0);
  currentPlan.forEach(r => recap[r.driver] += r.laps);

  let tb = $("recapTable");
  tb.innerHTML = "";

  Object.entries(recap).forEach(([name, laps])=>{
    let tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${name}</td>
      <td>${laps}</td>
    `;
    tb.appendChild(tr);
  });
}

// -------- Export PNG --------
function exportPNG(){
  if(!currentPlan) return alert("Aucun planning charg√©");

  let zone = $("exportArea");

  html2canvas(zone, { backgroundColor: "#05080f", scale: 2 }).then(canvas=>{

    let link = document.createElement("a");

    let filename = currentData && currentData.state && currentData.state.name 
      ? currentData.state.name 
      : "planning";

    // Nettoyage du nom de fichier
    filename = filename.replace(/[^\w\d-_ ]+/g, "").replace(/\s+/g, "_");

    link.download = filename + ".png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  });
}


// -------- INIT --------
refreshLoadList();
</script>

</body>
</html>
