<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>iRacing Endurance Planner</title>
  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; }
    td, th { padding: 6px 10px; }
    .bad { background-color: #ffb3b3; }

    #popup, #savePopup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .popupContent {
      background: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 300px;
      text-align: center;
    }

    .popupContent button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 8px;
    }
  </style>
</head>
<body>

<h1>iRacing Endurance Planner</h1>

<h2>Pilotes</h2>
<input type="text" id="driverName" placeholder="Nom du pilote">
<button onclick="addDriver()">â• Ajouter</button>
<div id="driversContainer"></div>

<hr>

<h2>Course</h2>
<label>Heure de dÃ©part</label>
<input type="time" id="startTime" value="13:00"><br><br>

<label>DurÃ©e de la course (heures)</label>
<input type="number" id="raceHours" value="6"><br><br>

<label>Type de relais</label>
<select id="stintMode">
  <option value="single">Simple relais</option>
  <option value="double">Double relais</option>
</select>

<hr>

<h2>Carburant</h2>
<label>CapacitÃ© rÃ©servoir (L)</label>
<input type="number" id="fuelCapacity" value="120"><br><br>

<label>Consommation par tour (L)</label>
<input type="number" id="fuelPerLap" value="3.2" step="0.01"><br><br>

<label>Temps au tour moyen (mm:ss)</label>
<input type="text" id="lapTime" value="01:45">

<hr>

<h2>Pit</h2>
<label>Temps de pit (secondes)</label>
<input type="number" id="pitSeconds" value="40"><br><br>

<button onclick="generateBasePlan()">ğŸ“‹ GÃ©nÃ©rer le planning</button>
<button onclick="openSavePopup()">ğŸ’¾ Sauvegarder / Charger</button>

<p id="stintInfo" style="font-weight:bold;"></p>
<p id="iracingRuleInfo" style="font-weight:bold;"></p>

<hr>

<h2>Planning</h2>
<table border="1">
  <thead>
    <tr>
      <th>DÃ©but</th>
      <th>Fin</th>
      <th>Pilote</th>
      <th>Tours</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="planTable"></tbody>
</table>

<hr>

<h2>ContrÃ´les</h2>
<div id="checks"></div>

<!-- Popup choix pilote -->
<div id="popup">
  <div class="popupContent">
    <h3>Choisir le pilote</h3>
    <div id="popupButtons"></div>
    <button onclick="closePopup()">Annuler</button>
  </div>
</div>

<!-- Popup sauvegarde -->
<div id="savePopup">
  <div class="popupContent">
    <h3>Sauvegardes</h3>
    <input type="text" id="saveName" placeholder="Nom du planning">
    <button onclick="savePlan()">ğŸ’¾ Sauvegarder</button>
    <hr>
    <div id="saveList"></div>
    <button onclick="closeSavePopup()">Fermer</button>
  </div>
</div>

<script>
let drivers = [];
let plan = [];
let changeIndex = null;

function qs(id){ return document.getElementById(id); }

// ----------------- Temps -----------------
function parseTimeToMinutes(t){ const p=t.split(":").map(Number); return p[0]*60+p[1]; }
function formatTime(m){ m=((m%1440)+1440)%1440; return String(Math.floor(m/60)).padStart(2,"0")+":"+String(Math.floor(m%60)).padStart(2,"0"); }
function intervalsOverlap(a,b,c,d){ return a<d && c<b; }

// ----------------- Pilotes -----------------
function addDriver(){
  const name=qs("driverName").value.trim();
  if(!name) return;
  drivers.push({name, unavailable:[]});
  qs("driverName").value="";
  renderDrivers();
}

function removeDriver(i){ drivers.splice(i,1); renderDrivers(); }

function addUnavailable(i){ drivers[i].unavailable.push({from:"00:00",to:"00:00"}); renderDrivers(); }
function updateUnavailable(i,j,f,v){ drivers[i].unavailable[j][f]=v; }
function removeUnavailable(i,j){ drivers[i].unavailable.splice(j,1); renderDrivers(); }

function renderDrivers(){
  const c=qs("driversContainer"); c.innerHTML="";
  drivers.forEach((d,i)=>{
    const div=document.createElement("div");
    div.style.border="1px solid #ccc"; div.style.padding="10px"; div.style.marginBottom="10px";
    div.innerHTML=`<b>${d.name}</b> <button onclick="removeDriver(${i})">âŒ</button><br>`;
    d.unavailable.forEach((u,j)=>{
      div.innerHTML+=`De <input type="time" value="${u.from}" onchange="updateUnavailable(${i},${j},'from',this.value)">
      Ã  <input type="time" value="${u.to}" onchange="updateUnavailable(${i},${j},'to',this.value)">
      <button onclick="removeUnavailable(${i},${j})">âŒ</button><br>`;
    });
    div.innerHTML+=`<button onclick="addUnavailable(${i})">â• Indispo</button>`;
    c.appendChild(div);
  });
}

// ----------------- Dispo -----------------
function isDriverAvailableForStint(driver,s,e){
  for(const u of driver.unavailable){
    const us=parseTimeToMinutes(u.from);
    const ue=parseTimeToMinutes(u.to);
    let ranges=[];
    if(us<ue){ ranges.push([us,ue]); ranges.push([us+1440,ue+1440]); }
    else if(us>ue){ ranges.push([us,ue+1440]); }
    else return false;
    let ss=s, ee=e; if(ee<ss) ee+=1440;
    for(const [rs,re] of ranges){
      if(intervalsOverlap(ss,ee,rs,re)) return false;
    }
  }
  return true;
}

// ----------------- GÃ©nÃ©ration -----------------
function generateBasePlan(){
  if(drivers.length===0) return alert("Ajoute des pilotes");

  const raceHours=+qs("raceHours").value;
  const stintMode=qs("stintMode").value;
  const [sh,sm]=qs("startTime").value.split(":").map(Number);
  const fuelCap=+qs("fuelCapacity").value;
  const fuelLap=+qs("fuelPerLap").value;
  const [lm,ls]=qs("lapTime").value.split(":").map(Number);
  const pitMin=+qs("pitSeconds").value/60;

  const lapSec=lm*60+ls;
  const lapsPerStint=Math.floor(fuelCap/fuelLap);
  const stintMin=(lapsPerStint*lapSec)/60;

  let current=sh*60+sm;
  let elapsed=0;
  let idx=0;
  let first=true;
  plan=[];

  while(elapsed<raceHours*60-0.01){
    if(!first){ current+=pitMin; elapsed+=pitMin; }
    first=false;

    let tries=0, sel=null;
    while(tries<drivers.length){
      const d=drivers[idx];
      if(isDriverAvailableForStint(d,current,current+stintMin)){ sel=d; break; }
      idx=(idx+1)%drivers.length; tries++;
    }
    if(!sel) return alert("Aucun pilote dispo");

    const rep=stintMode==="double"?2:1;
    for(let r=0;r<rep;r++){
      if(elapsed>=raceHours*60) break;
      plan.push({start:current,end:current+stintMin,driver:sel.name,laps:lapsPerStint});
      current+=stintMin; elapsed+=stintMin;
      if(r<rep-1){ current+=pitMin; elapsed+=pitMin; }
    }
    idx=(drivers.indexOf(sel)+1)%drivers.length;
  }

  qs("stintInfo").textContent=`Relais = ${lapsPerStint} tours â‰ˆ ${Math.round(stintMin)} min`;
  renderPlan(); checkRules();
}

// ----------------- Rendu -----------------
function renderPlan(){
  const tb=qs("planTable"); tb.innerHTML="";
  plan.forEach((r,i)=>{
    const tr=document.createElement("tr");
    const d=drivers.find(x=>x.name===r.driver);
    if(d && !isDriverAvailableForStint(d,r.start,r.end)) tr.classList.add("bad");
    tr.innerHTML=`<td>${formatTime(r.start)}</td><td>${formatTime(r.end)}</td><td>${r.driver}</td><td>${r.laps}</td>
    <td><button onclick="openPopup(${i})">ğŸ”</button></td>`;
    tb.appendChild(tr);
  });
}

// ----------------- Popup pilote -----------------
function openPopup(i){
  changeIndex=i;
  const c=qs("popupButtons"); c.innerHTML="";
  drivers.forEach(d=>{
    const b=document.createElement("button");
    b.textContent=d.name;
    b.onclick=()=>{
      const row=plan[changeIndex];
      const ok=isDriverAvailableForStint(d,row.start,row.end);
      if(!ok){
        if(!confirm(`âš ï¸ ${d.name} est indisponible sur ce crÃ©neau. Forcer quand mÃªme ?`)) return;
      }
      row.driver=d.name;
      closePopup(); renderPlan(); checkRules();
    };
    c.appendChild(b);
  });
  qs("popup").style.display="flex";
}
function closePopup(){ qs("popup").style.display="none"; }

// ----------------- Check rÃ¨gle -----------------
function checkRules(){
  const c=qs("checks"); c.innerHTML="";
  const laps={}; drivers.forEach(d=>laps[d.name]=0);
  plan.forEach(r=>{ if(laps[r.driver]!=null) laps[r.driver]+=r.laps; });

  const raceHours=+qs("raceHours").value;
  const [lm,ls]=qs("lapTime").value.split(":").map(Number);
  const lapSec=lm*60+ls;
  const totalLaps=Math.floor((raceHours*60)/(lapSec/60));
  const minLaps=Math.floor(totalLaps/drivers.length/4);

  qs("iracingRuleInfo").textContent=`RÃ¨gle iRacing: minimum ${minLaps} tours par pilote`;

  drivers.forEach(d=>{
    const ok=laps[d.name]>=minLaps;
    const div=document.createElement("div");
    div.textContent=`${d.name} : ${laps[d.name]} tours ${ok?"âœ…":"âŒ"}`;
    div.style.color=ok?"green":"red";
    c.appendChild(div);
  });
}

// ----------------- Sauvegardes -----------------
function openSavePopup(){ refreshSaveList(); qs("savePopup").style.display="flex"; }
function closeSavePopup(){ qs("savePopup").style.display="none"; }

function savePlan(){
  const name=qs("saveName").value.trim();
  if(!name) return alert("Nom requis");
  const data={drivers,plan,settings:{
    startTime:qs("startTime").value,
    raceHours:qs("raceHours").value,
    stintMode:qs("stintMode").value,
    fuelCapacity:qs("fuelCapacity").value,
    fuelPerLap:qs("fuelPerLap").value,
    lapTime:qs("lapTime").value,
    pitSeconds:qs("pitSeconds").value
  }};
  localStorage.setItem("plan_"+name, JSON.stringify(data));
  refreshSaveList();
}

function loadPlan(name){
  const data=JSON.parse(localStorage.getItem("plan_"+name));
  drivers=data.drivers; plan=data.plan;
  const s=data.settings;
  qs("startTime").value=s.startTime;
  qs("raceHours").value=s.raceHours;
  qs("stintMode").value=s.stintMode;
  qs("fuelCapacity").value=s.fuelCapacity;
  qs("fuelPerLap").value=s.fuelPerLap;
  qs("lapTime").value=s.lapTime;
  qs("pitSeconds").value=s.pitSeconds;
  renderDrivers(); renderPlan(); checkRules();
}

function deletePlan(name){
  if(confirm("Supprimer "+name+" ?")){
    localStorage.removeItem("plan_"+name);
    refreshSaveList();
  }
}

function refreshSaveList(){
  const d=qs("saveList"); d.innerHTML="";
  const keys=Object.keys(localStorage);
  keys.forEach(k=>{
    if(k.startsWith("plan_")){
      const name=k.replace("plan_","");
      const div=document.createElement("div");
      div.innerHTML=`<b>${name}</b> 
        <button onclick="loadPlan('${name}')">ğŸ“‚</button>
        <button onclick="deletePlan('${name}')">ğŸ—‘ï¸</button>`;
      d.appendChild(div);
    }
  });
  if(d.innerHTML==="") d.innerHTML="<i>Aucune sauvegarde</i>";
}
</script>

</body>
</html>
