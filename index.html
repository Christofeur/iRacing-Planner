<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>iRacing Endurance Planner</title>
<style>
body{font-family:Arial;background:#0b1320;color:#eee;padding:20px}
input,select,button{margin:3px;padding:5px}
table{border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #555;padding:6px}
.bad{background:#802020}
.popupBG{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.popup{background:#111;padding:20px;border-radius:10px;min-width:300px}
.popup button{width:100%;margin-top:5px}
</style>
</head>
<body>

<h1>iRacing Endurance Planner</h1>

<h2>Pilotes</h2>
<input id="driverName" placeholder="Nom du pilote">
<button onclick="addDriver()">‚ûï Ajouter</button>
<div id="drivers"></div>

<h2>Course</h2>
Heure d√©part <input type="time" id="startTime" value="13:00"><br>
Dur√©e (h) <input type="number" id="raceHours" value="6"><br>
Type relais 
<select id="stintMode">
<option value="single">Simple</option>
<option value="double">Double</option>
</select>

<h2>Carburant</h2>
R√©servoir (L) <input type="number" id="fuelCap" value="120"><br>
Conso/tour (L) <input type="number" id="fuelLap" value="3.2" step="0.01"><br>
Temps au tour (mm:ss) <input id="lapTime" value="01:45">

<h2>Pit</h2>
Temps pit (sec) <input type="number" id="pitSec" value="40">

<br><br>
<button onclick="generatePlan()">üìã G√©n√©rer le planning</button>
<button onclick="openSave()">üíæ Sauvegarder / Charger</button>

<p id="info"></p>

<h2>Planning</h2>
<table>
<thead><tr><th>D√©but</th><th>Fin</th><th>Pilote</th><th>Tours</th><th></th></tr></thead>
<tbody id="planTable"></tbody>
</table>

<h2>R√®gle iRacing</h2>
<div id="checks"></div>

<!-- POPUP PILOTES -->
<div class="popupBG" id="pilotPopup">
  <div class="popup">
    <h3>Choisir pilote</h3>
    <div id="pilotButtons"></div>
    <button onclick="closePilot()">Annuler</button>
  </div>
</div>

<!-- POPUP SAVE -->
<div class="popupBG" id="savePopup">
  <div class="popup">
    <h3>Sauvegardes</h3>
    <input id="saveName" placeholder="Nom du planning">
    <button onclick="savePlan()">üíæ Sauvegarder</button>
    <hr>
    <div id="saveList"></div>
    <button onclick="closeSave()">Fermer</button>
  </div>
</div>

<script>
let drivers=[];
let plan=[];
let editIndex=null;

function $(id){return document.getElementById(id);}

// ======== TEMPS ========
function parseTimeHM(t){ let [h,m]=t.split(":").map(Number); return h*3600 + m*60; }
function fmtTime(sec){
  sec = ((sec % 86400) + 86400) % 86400;
  let h = Math.floor(sec/3600);
  let m = Math.floor((sec%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

// ======== PILOTES ========
function addDriver(){
  let n=$("driverName").value.trim();
  if(!n) return;
  drivers.push({name:n,unavail:[]});
  $("driverName").value="";
  renderDrivers();
}

function renderDrivers(){
  let d=$("drivers"); d.innerHTML="";
  drivers.forEach((p,i)=>{
    let div=document.createElement("div");
    div.innerHTML=`<b>${p.name}</b> 
    <button onclick="drivers.splice(${i},1);renderDrivers()">‚ùå</button>
    <button onclick="drivers[${i}].unavail.push({from:'00:00',to:'00:00'});renderDrivers()">+ Indispo</button>`;

    p.unavail.forEach((u,j)=>{
      div.innerHTML+=`<br>De <input type="time" value="${u.from}" 
        onchange="drivers[${i}].unavail[${j}].from=this.value">
        √† <input type="time" value="${u.to}" 
        onchange="drivers[${i}].unavail[${j}].to=this.value">
        <button onclick="drivers[${i}].unavail.splice(${j},1);renderDrivers()">‚ùå</button>`;
    });
    d.appendChild(div);
  });
}

// ======== DISPONIBILIT√â ========
function isAvailable(p, start, end){
  for(let u of p.unavail){
    let a = parseTimeHM(u.from);
    let b = parseTimeHM(u.to);

    let s = start;
    let e = end;
    if(e < s) e += 86400;

    let ranges=[];
    if(a < b){
      ranges.push([a,b]);
      ranges.push([a+86400,b+86400]);
    } else if(a > b){
      ranges.push([a,b+86400]);
    } else {
      return false;
    }

    for(let r of ranges){
      if(s < r[1] && r[0] < e) return false;
    }
  }
  return true;
}

// ======== G√âN√âRATION ========
function generatePlan(){
  if(drivers.length==0) return alert("Ajoute des pilotes");

  let start = parseTimeHM($("startTime").value);
  let raceHours = +$("raceHours").value;

  let fuelCap = +$("fuelCap").value;
  let fuelLap = +$("fuelLap").value;
  let [lm,ls] = $("lapTime").value.split(":").map(Number);
  let lapSec = lm*60 + ls;
  let pitSec = +$("pitSec").value;

  let laps = Math.floor(fuelCap / fuelLap);
  let stintSec = laps * lapSec;

  $("info").textContent = `Relais = ${laps} tours ‚âà ${Math.round(stintSec/60)} min`;

  plan=[];
  let t = start;
  let elapsed = 0;
  let idx = 0;
  let first = true;

  while(elapsed < raceHours*3600 - 1){
    if(!first){
      t += pitSec;
      elapsed += pitSec;
    }
    first = false;

    let p = drivers[idx];
    let rep = $("stintMode").value=="double" ? 2 : 1;

    for(let r=0;r<rep;r++){
      if(elapsed >= raceHours*3600) break;

      plan.push({
        start: t,
        end: t + stintSec,
        driver: p.name,
        laps: laps
      });

      t += stintSec;
      elapsed += stintSec;

      if(r < rep-1){
        t += pitSec;
        elapsed += pitSec;
      }
    }

    idx = (idx+1) % drivers.length;
  }

  renderPlan();
  checkRules();
}

// ======== AFFICHAGE ========
function renderPlan(){
  let tb = $("planTable");
  tb.innerHTML = "";

  plan.forEach((r,i)=>{
    let tr = document.createElement("tr");
    let p = drivers.find(d=>d.name==r.driver);
    if(p && !isAvailable(p, r.start, r.end)) tr.classList.add("bad");

    tr.innerHTML = `
      <td>${fmtTime(r.start)}</td>
      <td>${fmtTime(r.end)}</td>
      <td>${r.driver}</td>
      <td>${r.laps}</td>
      <td><button onclick="openPilot(${i})">üîÅ</button></td>
    `;
    tb.appendChild(tr);
  });
}

// ======== CHANGEMENT PILOTE ========
function openPilot(i){
  editIndex = i;
  let d = $("pilotButtons"); d.innerHTML = "";

  drivers.forEach(p=>{
    let b = document.createElement("button");
    b.textContent = p.name;
    b.onclick = ()=>{
      let r = plan[editIndex];
      if(!isAvailable(p, r.start, r.end)){
        if(!confirm("Pilote indisponible sur ce cr√©neau. Forcer ?")) return;
      }
      r.driver = p.name;
      closePilot();
      renderPlan();
      checkRules();
    };
    d.appendChild(b);
  });

  $("pilotPopup").style.display="flex";
}
function closePilot(){ $("pilotPopup").style.display="none"; }

// ======== R√àGLE IRACING ========
function checkRules(){
  let c = $("checks"); c.innerHTML = "";
  let count = {};
  drivers.forEach(d=>count[d.name]=0);
  plan.forEach(r=>count[r.driver]+=r.laps);

  let raceHours = +$("raceHours").value;
  let [lm,ls] = $("lapTime").value.split(":").map(Number);
  let lapSec = lm*60 + ls;

  let total = Math.floor((raceHours*3600)/lapSec);
  let min = Math.floor(total/drivers.length/4);

  drivers.forEach(d=>{
    let ok = count[d.name] >= min;
    let div = document.createElement("div");
    div.textContent = `${d.name} : ${count[d.name]} tours (min ${min})`;
    div.style.color = ok ? "lightgreen" : "red";
    c.appendChild(div);
  });
}
</script>
</body>
</html>

