<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>iRacing Endurance Planner (Stable)</title>
<style>
body { font-family: Arial, sans-serif; padding:20px; background:#111; color:#eee; }
input, select, button { margin:3px; padding:5px; }
table { border-collapse: collapse; margin-top:10px; }
td, th { border:1px solid #555; padding:6px; }
.bad { background:#802020; }
.block { border:1px solid #444; padding:10px; margin-bottom:10px; }

.popupBG {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
}
.popup {
  background: #222;
  padding: 20px;
  border-radius: 10px;
}
</style>
</head>
<body>

<h1>iRacing Endurance Planner (version stable)</h1>

<div class="block">
<h2>Nom du planning</h2>
<input id="planName" placeholder="Ex: Spa 24h - Team X">
</div>

<div class="block">
<h2>Pilotes</h2>
<input id="driverName" placeholder="Nom du pilote">
<button onclick="addDriver()">‚ûï Ajouter</button>
<div id="drivers"></div>
</div>

<div class="block">
<h2>Course</h2>
Heure d√©part <input type="time" id="startTime" value="13:00"><br>
Dur√©e (heures) <input type="number" id="raceHours" value="6"><br>
Type relais 
<select id="stintMode">
  <option value="single">Simple</option>
  <option value="double">Double</option>
</select>
</div>

<div class="block">
<h2>Carburant</h2>
Capacit√© r√©servoir (L) <input type="number" id="fuelCap" value="120"><br>
Conso par tour (L) <input type="number" id="fuelLap" value="3.2" step="0.01"><br>
Temps au tour (mm:ss) <input id="lapTime" value="01:45"><br>
Temps de pit (secondes) <input type="number" id="pitSec" value="40">
</div>

<div class="block">
<button onclick="generatePlan()">üìã G√©n√©rer le planning</button>
<button onclick="savePlan()">üíæ Sauvegarder</button>

<br><br>

<select id="loadSelect"></select>
<button onclick="loadSelectedPlan()">üìÇ Charger</button>
<button onclick="deleteSelectedPlan()">üóëÔ∏è Supprimer</button>
</div>

<p id="info"></p>

<h2>Planning</h2>
<table>
<thead>
<tr><th>D√©but</th><th>Fin</th><th>Pilote</th><th>Tours</th><th>Action</th></tr>
</thead>
<tbody id="planTable"></tbody>
</table>

<h2>R√®gle iRacing</h2>
<div id="checks"></div>

<!-- POPUP MODIF PILOTE -->
<div class="popupBG" id="editPopup">
  <div class="popup">
    <h3>Changer le pilote</h3>
    <select id="editSelect"></select><br><br>
    <button onclick="confirmEdit()">Valider</button>
    <button onclick="closeEdit()">Annuler</button>
  </div>
</div>

<script>
let state = {
  name: "",
  drivers: [],
  plan: [],
  settings: {}
};

let editIndex = null;

function $(id){ return document.getElementById(id); }

// ---------- Temps ----------
function parseHM(t){
  let [h,m] = t.split(":").map(Number);
  return h*3600 + m*60;
}
function fmt(sec){
  sec = ((sec % 86400) + 86400) % 86400;
  let h = Math.floor(sec/3600);
  let m = Math.floor((sec%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

// ---------- Pilotes ----------
function addDriver(){
  let n = $("driverName").value.trim();
  if(!n) return;
  state.drivers.push({ name:n, unavail:[] });
  $("driverName").value="";
  renderDrivers();
}

function renderDrivers(){
  let d = $("drivers");
  d.innerHTML="";
  state.drivers.forEach((p,i)=>{
    let div = document.createElement("div");
    div.className="block";
    div.innerHTML = `<b>${p.name}</b>
      <button onclick="state.drivers.splice(${i},1);renderDrivers()">‚ùå</button>
      <button onclick="state.drivers[${i}].unavail.push({from:'00:00',to:'00:00'});renderDrivers()">+ Indispo</button>
    `;
    p.unavail.forEach((u,j)=>{
      div.innerHTML += `<br>De <input type="time" value="${u.from}"
        onchange="state.drivers[${i}].unavail[${j}].from=this.value">
        √† <input type="time" value="${u.to}"
        onchange="state.drivers[${i}].unavail[${j}].to=this.value">
        <button onclick="state.drivers[${i}].unavail.splice(${j},1);renderDrivers()">‚ùå</button>`;
    });
    d.appendChild(div);
  });
}

// ---------- Disponibilit√© ----------
function isAvailable(driver, startSec, endSec){
  for(let u of driver.unavail){
    let a = parseHM(u.from);
    let b = parseHM(u.to);

    let s = startSec;
    let e = endSec;
    if(e < s) e += 86400;

    let ranges = [];
    if(a < b){
      ranges.push([a, b]);
      ranges.push([a+86400, b+86400]);
    } else if(a > b){
      ranges.push([a, b+86400]);
    } else {
      return false;
    }

    for(let r of ranges){
      if(s < r[1] && r[0] < e){
        return false;
      }
    }
  }
  return true;
}

// ---------- G√©n√©ration ----------
function generatePlan(){
  if(state.drivers.length === 0){
    alert("Ajoute des pilotes");
    return;
  }

  let start = parseHM($("startTime").value);
  let raceHours = +$("raceHours").value;

  let fuelCap = +$("fuelCap").value;
  let fuelLap = +$("fuelLap").value;
  let [lm,ls] = $("lapTime").value.split(":").map(Number);
  let lapSec = lm*60 + ls;
  let pitSec = +$("pitSec").value;

  let laps = Math.floor(fuelCap / fuelLap);
  let stintSec = laps * lapSec;

  $("info").textContent = `Relais = ${laps} tours ‚âà ${Math.round(stintSec/60)} min`;

  state.plan = [];

  let t = start;
  let elapsed = 0;
  let idx = 0;
  let first = true;

  while(elapsed < raceHours*3600 - 1){
    if(!first){
      t += pitSec;
      elapsed += pitSec;
    }
    first = false;

    let found = null;
    let tries = 0;
    while(tries < state.drivers.length){
      let p = state.drivers[idx];
      if(isAvailable(p, t, t+stintSec)){
        found = p;
        break;
      }
      idx = (idx+1) % state.drivers.length;
      tries++;
    }

    if(!found){
      alert("Aucun pilote disponible √† " + fmt(t));
      return;
    }

    let rep = $("stintMode").value === "double" ? 2 : 1;

    for(let r=0;r<rep;r++){
      if(elapsed >= raceHours*3600) break;

      state.plan.push({
        start: t,
        end: t + stintSec,
        driver: found.name,
        laps: laps
      });

      t += stintSec;
      elapsed += stintSec;

      if(r < rep-1){
        t += pitSec;
        elapsed += pitSec;
      }
    }

    idx = (idx + 1) % state.drivers.length;
  }

  renderPlan();
  checkRules();
}

// ---------- Affichage ----------
function renderPlan(){
  let tb = $("planTable");
  tb.innerHTML = "";
  state.plan.forEach((r,i)=>{
    let tr = document.createElement("tr");
    let p = state.drivers.find(d=>d.name===r.driver);
    if(p && !isAvailable(p, r.start, r.end)){
      tr.classList.add("bad");
    }
    tr.innerHTML = `
      <td>${fmt(r.start)}</td>
      <td>${fmt(r.end)}</td>
      <td>${r.driver}</td>
      <td>${r.laps}</td>
      <td><button onclick="openEdit(${i})">üîÅ Changer</button></td>
    `;
    tb.appendChild(tr);
  });
}

// ---------- Popup √©dition ----------
function openEdit(i){
  editIndex = i;
  let sel = $("editSelect");
  sel.innerHTML = "";
  state.drivers.forEach(d=>{
    let opt = document.createElement("option");
    opt.value = d.name;
    opt.textContent = d.name;
    sel.appendChild(opt);
  });
  sel.value = state.plan[i].driver;
  $("editPopup").style.display = "flex";
}

function closeEdit(){
  $("editPopup").style.display = "none";
}

function confirmEdit(){
  let newDriverName = $("editSelect").value;
  let stint = state.plan[editIndex];
  let driver = state.drivers.find(d=>d.name === newDriverName);

  if(!isAvailable(driver, stint.start, stint.end)){
    if(!confirm("‚ö†Ô∏è Ce pilote est indisponible sur ce cr√©neau. Forcer quand m√™me ?")){
      return;
    }
  }

  stint.driver = newDriverName;
  closeEdit();
  renderPlan();
  checkRules();
}

// ---------- R√®gle iRacing ----------
function checkRules(){
  let c = $("checks");
  c.innerHTML = "";

  let count = {};
  state.drivers.forEach(d=>count[d.name]=0);
  state.plan.forEach(r=>count[r.driver]+=r.laps);

  let raceHours = +$("raceHours").value;
  let [lm,ls] = $("lapTime").value.split(":").map(Number);
  let lapSec = lm*60 + ls;

  let total = Math.floor((raceHours*3600)/lapSec);
  let min = Math.floor(total / state.drivers.length / 4);

  c.innerHTML = `<b>Minimum requis: ${min} tours</b><br>`;

  state.drivers.forEach(d=>{
    let ok = count[d.name] >= min;
    let div = document.createElement("div");
    div.textContent = `${d.name} : ${count[d.name]} tours`;
    div.style.color = ok ? "lightgreen" : "red";
    c.appendChild(div);
  });
}

// ---------- Sauvegarde / Chargement / Suppression ----------
// (identique √† ta version pr√©c√©dente, inchang√© pour stabilit√©)

function savePlan(){
  let name = $("planName").value.trim();
  if(!name){
    alert("Donne un nom au planning");
    return;
  }
  state.name = name;

  let data = {
    state: state,
    form: {
      startTime: $("startTime").value,
      raceHours: $("raceHours").value,
      stintMode: $("stintMode").value,
      fuelCap: $("fuelCap").value,
      fuelLap: $("fuelLap").value,
      lapTime: $("lapTime").value,
      pitSec: $("pitSec").value
    }
  };

  localStorage.setItem("iracing_plan_" + name, JSON.stringify(data));
  refreshLoadList();
  alert("Sauvegarde OK");
}

function refreshLoadList(){
  let sel = $("loadSelect");
  sel.innerHTML = "";

  let keys = Object.keys(localStorage).filter(k => k.startsWith("iracing_plan_"));

  if(keys.length === 0){
    let opt = document.createElement("option");
    opt.textContent = "Aucune sauvegarde";
    opt.value = "";
    sel.appendChild(opt);
    return;
  }

  keys.forEach(k=>{
    let name = k.replace("iracing_plan_","");
    let opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
}

function loadSelectedPlan(){
  let name = $("loadSelect").value;
  if(!name){
    alert("Aucune sauvegarde s√©lectionn√©e");
    return;
  }

  let raw = localStorage.getItem("iracing_plan_" + name);
  if(!raw){
    alert("Sauvegarde introuvable");
    return;
  }

  let data = JSON.parse(raw);
  state = data.state;

  $("planName").value = state.name;
  $("startTime").value = data.form.startTime;
  $("raceHours").value = data.form.raceHours;
  $("stintMode").value = data.form.stintMode;
  $("fuelCap").value = data.form.fuelCap;
  $("fuelLap").value = data.form.fuelLap;
  $("lapTime").value = data.form.lapTime;
  $("pitSec").value = data.form.pitSec;

  renderDrivers();
  renderPlan();
  checkRules();

  alert("Chargement OK");
}

function deleteSelectedPlan(){
  let name = $("loadSelect").value;
  if(!name){
    alert("Aucune sauvegarde s√©lectionn√©e");
    return;
  }

  if(!confirm("Supprimer d√©finitivement le planning \"" + name + "\" ?")){
    return;
  }

  localStorage.removeItem("iracing_plan_" + name);
  refreshLoadList();
  alert("Supprim√©");
}

// init
refreshLoadList();
</script>

</body>
</html>
