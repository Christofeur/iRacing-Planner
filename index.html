<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>iRacing Endurance Planner</title>
</head>
<body>

<h1>iRacing Endurance Planner</h1>

<h2>Pilotes</h2>

<input type="text" id="driverName" placeholder="Nom du pilote">
<button onclick="addDriver()">‚ûï Ajouter</button>

<ul id="driversList"></ul>

<hr>

<h2>Course</h2>

<label>Heure de d√©part</label>
<input type="time" id="startTime" value="13:00">

<br><br>

<label>Dur√©e de la course (heures)</label>
<input type="number" id="raceHours" value="6">

<br><br>

<label>Type de relais</label>
<select id="stintMode">
  <option value="single">Simple relais</option>
  <option value="double">Double relais</option>
</select>

<hr>

<h2>Carburant</h2>

<label>Capacit√© r√©servoir (L)</label>
<input type="number" id="fuelCapacity" value="120">

<br><br>

<label>Consommation par tour (L)</label>
<input type="number" id="fuelPerLap" value="3.2" step="0.01">

<br><br>

<label>Temps au tour moyen (mm:ss)</label>
<input type="text" id="lapTime" value="01:45">

<hr>

<h2>Pit</h2>

<label>Temps de pit (secondes)</label>
<input type="number" id="pitSeconds" value="40">

<br><br>

<button onclick="generatePlan()">üìã G√©n√©rer le planning</button>

<p id="stintInfo" style="font-weight:bold;"></p>

<hr>

<h2>Planning</h2>

<table border="1" cellpadding="5">
  <thead>
    <tr>
      <th>D√©but</th>
      <th>Fin</th>
      <th>Pilote</th>
    </tr>
  </thead>
  <tbody id="planTable"></tbody>
</table>

<script>
let drivers = [];

function addDriver() {
  const input = document.getElementById("driverName");
  const name = input.value.trim();
  if (!name) return;

  drivers.push(name);
  input.value = "";
  renderDrivers();
}

function removeDriver(index) {
  drivers.splice(index, 1);
  renderDrivers();
}

function renderDrivers() {
  const ul = document.getElementById("driversList");
  ul.innerHTML = "";

  drivers.forEach((name, i) => {
    const li = document.createElement("li");
    li.textContent = name + " ";

    const btn = document.createElement("button");
    btn.textContent = "‚ùå";
    btn.onclick = () => removeDriver(i);

    li.appendChild(btn);
    ul.appendChild(li);
  });
}

function parseTimeToSeconds(t) {
  const parts = t.split(":").map(Number);
  return parts[0] * 60 + parts[1];
}

function formatTime(totalMinutes) {
  let m = ((totalMinutes % (24 * 60)) + (24 * 60)) % (24 * 60);
  const h = Math.floor(m / 60).toString().padStart(2, "0");
  const min = Math.floor(m % 60).toString().padStart(2, "0");
  return `${h}:${min}`;
}

function generatePlan() {
  const raceHours = Number(document.getElementById("raceHours").value);
  const stintMode = document.getElementById("stintMode").value;
  const startTimeStr = document.getElementById("startTime").value;

  const fuelCapacity = Number(document.getElementById("fuelCapacity").value);
  const fuelPerLap = Number(document.getElementById("fuelPerLap").value);
  const lapTimeStr = document.getElementById("lapTime").value;

  const pitSeconds = Number(document.getElementById("pitSeconds").value);

  if (drivers.length === 0) {
    alert("Ajoute au moins un pilote");
    return;
  }

  if (!startTimeStr) {
    alert("Heure de d√©part invalide");
    return;
  }

  if (raceHours <= 0 || fuelCapacity <= 0 || fuelPerLap <= 0) {
    alert("Param√®tres invalides");
    return;
  }

  const lapTimeSeconds = parseTimeToSeconds(lapTimeStr);

  const lapsPerStint = Math.floor(fuelCapacity / fuelPerLap);
  const stintSeconds = lapsPerStint * lapTimeSeconds;
  const stintMinutes = stintSeconds / 60;

  const pitMinutes = pitSeconds / 60;

  document.getElementById("stintInfo").innerText =
    `Relais = ${lapsPerStint} tours ‚âà ${Math.round(stintMinutes)} min | Pit = ${pitSeconds}s`;

  const [startH, startM] = startTimeStr.split(":").map(Number);
  let currentTime = startH * 60 + startM;

  const totalMinutes = raceHours * 60;

  const table = document.getElementById("planTable");
  table.innerHTML = "";

  let elapsed = 0;
  let driverIndex = 0;
  let firstStint = true;

  while (elapsed < totalMinutes - 0.01) {
    const driver = drivers[driverIndex];
    const repeats = (stintMode === "double") ? 2 : 1;

    for (let r = 0; r < repeats; r++) {
      if (elapsed >= totalMinutes - 0.01) break;

      // Ajouter le temps de pit AVANT le relais (sauf tout premier)
      if (!firstStint) {
        currentTime += pitMinutes;
        elapsed += pitMinutes;
      }
      firstStint = false;

      const start = currentTime;
      const end = currentTime + stintMinutes;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatTime(start)}</td>
        <td>${formatTime(end)}</td>
        <td>${driver}</td>
      `;
      table.appendChild(tr);

      currentTime = end;
      elapsed += stintMinutes;
    }

    driverIndex = (driverIndex + 1) % drivers.length;
  }
}
</script>

</body>
</html>
