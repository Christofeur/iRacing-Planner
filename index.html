<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>iRacing Endurance Planner</title>
  <style>
    body { font-family: Arial, sans-serif; }
    table { border-collapse: collapse; }
    td, th { padding: 6px 10px; }

    .bad {
      background-color: #ffb3b3;
    }

    #popup {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }

    #popupContent {
      background: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 250px;
      text-align: center;
    }

    #popupContent button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 8px;
    }
  </style>
</head>
<body>

<h1>iRacing Endurance Planner</h1>

<h2>Pilotes</h2>

<input type="text" id="driverName" placeholder="Nom du pilote">
<button onclick="addDriver()">‚ûï Ajouter</button>

<div id="driversContainer"></div>

<hr>

<h2>Course</h2>

<label>Heure de d√©part</label>
<input type="time" id="startTime" value="13:00">

<br><br>

<label>Dur√©e de la course (heures)</label>
<input type="number" id="raceHours" value="6">

<br><br>

<label>Type de relais</label>
<select id="stintMode">
  <option value="single">Simple relais</option>
  <option value="double">Double relais</option>
</select>

<hr>

<h2>Carburant</h2>

<label>Capacit√© r√©servoir (L)</label>
<input type="number" id="fuelCapacity" value="120">

<br><br>

<label>Consommation par tour (L)</label>
<input type="number" id="fuelPerLap" value="3.2" step="0.01">

<br><br>

<label>Temps au tour moyen (mm:ss)</label>
<input type="text" id="lapTime" value="01:45">

<hr>

<h2>Pit</h2>

<label>Temps de pit (secondes)</label>
<input type="number" id="pitSeconds" value="40">

<br><br>

<button onclick="generateBasePlan()">üìã G√©n√©rer le planning de base</button>

<p id="stintInfo" style="font-weight:bold;"></p>
<p id="iracingRuleInfo" style="font-weight:bold;"></p>

<hr>

<h2>Planning (√©ditable)</h2>

<table border="1">
  <thead>
    <tr>
      <th>D√©but</th>
      <th>Fin</th>
      <th>Pilote</th>
      <th>Tours</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="planTable"></tbody>
</table>

<hr>

<h2>Contr√¥les</h2>
<div id="checks"></div>

<!-- POPUP -->
<div id="popup">
  <div id="popupContent">
    <h3>Choisir le pilote</h3>
    <div id="popupButtons"></div>
    <button onclick="closePopup()">Annuler</button>
  </div>
</div>

<script>
let drivers = [];
let plan = [];
let changeIndex = null;

// ---------- Gestion pilotes ----------

function addDriver() {
  const input = document.getElementById("driverName");
  const name = input.value.trim();
  if (!name) return;

  drivers.push({
    name: name,
    unavailable: []
  });

  input.value = "";
  renderDrivers();
}

function removeDriver(index) {
  drivers.splice(index, 1);
  renderDrivers();
}

function addUnavailable(index) {
  drivers[index].unavailable.push({ from: "00:00", to: "00:00" });
  renderDrivers();
}

function updateUnavailable(driverIndex, unavIndex, field, value) {
  drivers[driverIndex].unavailable[unavIndex][field] = value;
}

function removeUnavailable(driverIndex, unavIndex) {
  drivers[driverIndex].unavailable.splice(unavIndex, 1);
  renderDrivers();
}

function renderDrivers() {
  const container = document.getElementById("driversContainer");
  container.innerHTML = "";

  drivers.forEach((driver, i) => {
    const div = document.createElement("div");
    div.style.border = "1px solid #ccc";
    div.style.padding = "10px";
    div.style.marginBottom = "10px";

    let html = `<strong>${driver.name}</strong> 
      <button onclick="removeDriver(${i})">‚ùå Supprimer</button>
      <br><em>Indisponibilit√©s :</em><br>`;

    driver.unavailable.forEach((u, j) => {
      html += `
        <div>
          De <input type="time" value="${u.from}" onchange="updateUnavailable(${i}, ${j}, 'from', this.value)">
          √† <input type="time" value="${u.to}" onchange="updateUnavailable(${i}, ${j}, 'to', this.value)">
          <button onclick="removeUnavailable(${i}, ${j})">‚ùå</button>
        </div>
      `;
    });

    html += `<button onclick="addUnavailable(${i})">‚ûï Ajouter indisponibilit√©</button>`;
    div.innerHTML = html;
    container.appendChild(div);
  });
}

// ---------- Temps ----------

function parseTimeToMinutes(t) {
  const parts = t.split(":").map(Number);
  return parts[0] * 60 + parts[1];
}

function formatTime(totalMinutes) {
  let m = ((totalMinutes % 1440) + 1440) % 1440;
  const h = Math.floor(m / 60).toString().padStart(2, "0");
  const min = Math.floor(m % 60).toString().padStart(2, "0");
  return `${h}:${min}`;
}

// ---------- Disponibilit√© ----------

function intervalsOverlap(aStart, aEnd, bStart, bEnd) {
  return aStart < bEnd && bStart < aEnd;
}

function isDriverAvailableForStint(driver, stintStart, stintEnd) {
  for (const u of driver.unavailable) {
    if (!u.from || !u.to) continue;

    const uStart = parseTimeToMinutes(u.from);
    const uEnd = parseTimeToMinutes(u.to);

    let ranges = [];

    if (uStart < uEnd) {
      ranges.push([uStart, uEnd]);
      ranges.push([uStart + 1440, uEnd + 1440]);
    } else if (uStart > uEnd) {
      ranges.push([uStart, uEnd + 1440]);
    } else {
      return false;
    }

    let sStart = stintStart;
    let sEnd = stintEnd;
    if (sEnd < sStart) sEnd += 1440;

    for (const [rStart, rEnd] of ranges) {
      if (intervalsOverlap(sStart, sEnd, rStart, rEnd)) {
        return false;
      }
    }
  }
  return true;
}

// ---------- G√©n√©ration de base ----------

function generateBasePlan() {
  if (drivers.length === 0) {
    alert("Ajoute des pilotes");
    return;
  }

  const raceHours = Number(document.getElementById("raceHours").value);
  const stintMode = document.getElementById("stintMode").value;
  const startTimeStr = document.getElementById("startTime").value;

  const fuelCapacity = Number(document.getElementById("fuelCapacity").value);
  const fuelPerLap = Number(document.getElementById("fuelPerLap").value);
  const lapTimeStr = document.getElementById("lapTime").value;
  const pitSeconds = Number(document.getElementById("pitSeconds").value);

  const [ltM, ltS] = lapTimeStr.split(":").map(Number);
  const lapTimeSeconds = ltM * 60 + ltS;

  const lapsPerStint = Math.floor(fuelCapacity / fuelPerLap);
  const stintMinutes = (lapsPerStint * lapTimeSeconds) / 60;
  const pitMinutes = pitSeconds / 60;

  const totalMinutes = raceHours * 60;

  const [startH, startM] = startTimeStr.split(":").map(Number);
  let currentTime = startH * 60 + startM;

  let elapsed = 0;
  let driverIndex = 0;
  let first = true;

  plan = [];

  while (elapsed < totalMinutes - 0.01) {

    if (!first) {
      currentTime += pitMinutes;
      elapsed += pitMinutes;
    }
    first = false;

    let tries = 0;
    let selected = null;

    while (tries < drivers.length) {
      const d = drivers[driverIndex];
      const s = currentTime;
      const e = currentTime + stintMinutes;

      if (isDriverAvailableForStint(d, s, e)) {
        selected = d;
        break;
      }
      driverIndex = (driverIndex + 1) % drivers.length;
      tries++;
    }

    if (!selected) {
      alert("Aucun pilote dispo √† " + formatTime(currentTime));
      return;
    }

    const repeats = (stintMode === "double") ? 2 : 1;

    for (let r = 0; r < repeats; r++) {
      if (elapsed >= totalMinutes - 0.01) break;

      const s = currentTime;
      const e = currentTime + stintMinutes;

      plan.push({
        start: s,
        end: e,
        driver: selected.name,
        laps: lapsPerStint
      });

      currentTime = e;
      elapsed += stintMinutes;

      if (r < repeats - 1) {
        currentTime += pitMinutes;
        elapsed += pitMinutes;
      }
    }

    driverIndex = (drivers.indexOf(selected) + 1) % drivers.length;
  }

  document.getElementById("stintInfo").innerText =
    `Relais = ${lapsPerStint} tours ‚âà ${Math.round(stintMinutes)} min`;

  renderPlan();
  checkRules();
}

// ---------- Rendu & √©dition ----------

function renderPlan() {
  const tbody = document.getElementById("planTable");
  tbody.innerHTML = "";

  plan.forEach((row, i) => {
    const tr = document.createElement("tr");

    // V√©rifier indispo
    const driverObj = drivers.find(d => d.name === row.driver);
    const bad = driverObj && !isDriverAvailableForStint(driverObj, row.start, row.end);

    if (bad) {
      tr.classList.add("bad");
    }

    tr.innerHTML = `
      <td>${formatTime(row.start)}</td>
      <td>${formatTime(row.end)}</td>
      <td>${row.driver}</td>
      <td>${row.laps}</td>
      <td><button onclick="openPopup(${i})">üîÅ Changer</button></td>
    `;

    tbody.appendChild(tr);
  });
}

// ---------- Popup ----------

function openPopup(index) {
  changeIndex = index;
  const container = document.getElementById("popupButtons");
  container.innerHTML = "";

  drivers.forEach(d => {
    const b = document.createElement("button");
    b.textContent = d.name;
    b.onclick = () => {
      plan[changeIndex].driver = d.name;
      closePopup();
      renderPlan();
      checkRules();
    };
    container.appendChild(b);
  });

  document.getElementById("popup").style.display = "flex";
}

function closePopup() {
  document.getElementById("popup").style.display = "none";
  changeIndex = null;
}

// ---------- V√©rifications ----------

function checkRules() {
  const checks = document.getElementById("checks");
  checks.innerHTML = "";

  const lapsByDriver = {};
  drivers.forEach(d => lapsByDriver[d.name] = 0);

  for (const row of plan) {
    if (lapsByDriver[row.driver] !== undefined) {
      lapsByDriver[row.driver] += row.laps;
    }
  }

  const raceHours = Number(document.getElementById("raceHours").value);
  const lapTimeStr = document.getElementById("lapTime").value;
  const [ltM, ltS] = lapTimeStr.split(":").map(Number);
  const lapTimeSeconds = ltM * 60 + ltS;

  const totalMinutes = raceHours * 60;
  const totalLaps = Math.floor(totalMinutes / (lapTimeSeconds / 60));
  const minLaps = Math.floor(totalLaps / drivers.length / 4);

  document.getElementById("iracingRuleInfo").innerText =
    `R√®gle iRacing: minimum ${minLaps} tours par pilote`;

  for (const d of drivers) {
    const v = document.createElement("div");
    const laps = lapsByDriver[d.name] || 0;
    const ok = laps >= minLaps;

    v.textContent = `${d.name} : ${laps} tours ${ok ? "‚úÖ" : "‚ùå"}`;
    v.style.color = ok ? "green" : "red";
    checks.appendChild(v);
  }
}
</script>

</body>
</html>
