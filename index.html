<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>iRacing Endurance Planner</title>
<style>
body{font-family:Arial;background:#0b1320;color:#eee;padding:20px}
input,select,button{margin:3px;padding:5px}
table{border-collapse:collapse;margin-top:10px}
td,th{border:1px solid #555;padding:6px}
.bad{background:#802020}
.popupBG{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.popup{background:#111;padding:20px;border-radius:10px;min-width:300px}
.popup button{width:100%;margin-top:5px}
</style>
</head>
<body>

<h1>iRacing Endurance Planner</h1>

<h2>Pilotes</h2>
<input id="driverName" placeholder="Nom du pilote">
<button onclick="addDriver()">â• Ajouter</button>
<div id="drivers"></div>

<h2>Course</h2>
Heure dÃ©part <input type="time" id="startTime" value="13:00"><br>
DurÃ©e (h) <input type="number" id="raceHours" value="6"><br>
Type relais 
<select id="stintMode">
<option value="single">Simple</option>
<option value="double">Double</option>
</select>

<h2>Carburant</h2>
RÃ©servoir (L) <input type="number" id="fuelCap" value="120"><br>
Conso/tour (L) <input type="number" id="fuelLap" value="3.2" step="0.01"><br>
Temps au tour (mm:ss) <input id="lapTime" value="01:45">

<h2>Pit</h2>
Temps pit (sec) <input type="number" id="pitSec" value="40">

<br><br>
<button onclick="generatePlan()">ğŸ“‹ GÃ©nÃ©rer le planning</button>
<button onclick="openSave()">ğŸ’¾ Sauvegarder / Charger</button>

<p id="info"></p>

<h2>Planning</h2>
<table>
<thead><tr><th>DÃ©but</th><th>Fin</th><th>Pilote</th><th>Tours</th><th></th></tr></thead>
<tbody id="planTable"></tbody>
</table>

<h2>RÃ¨gle iRacing</h2>
<div id="checks"></div>

<!-- POPUP PILOTES -->
<div class="popupBG" id="pilotPopup">
  <div class="popup">
    <h3>Choisir pilote</h3>
    <div id="pilotButtons"></div>
    <button onclick="closePilot()">Annuler</button>
  </div>
</div>

<!-- POPUP SAVE -->
<div class="popupBG" id="savePopup">
  <div class="popup">
    <h3>Sauvegardes</h3>
    <input id="saveName" placeholder="Nom du planning">
    <button onclick="savePlan()">ğŸ’¾ Sauvegarder</button>
    <hr>
    <div id="saveList"></div>
    <button onclick="closeSave()">Fermer</button>
  </div>
</div>

<script>
let drivers=[];
let plan=[];
let editIndex=null;

function $(id){return document.getElementById(id);}

function addDriver(){
  let n=$("driverName").value.trim();
  if(!n) return;
  drivers.push({name:n,unavail:[]});
  $("driverName").value="";
  renderDrivers();
}

function renderDrivers(){
  let d=$("drivers"); d.innerHTML="";
  drivers.forEach((p,i)=>{
    let div=document.createElement("div");
    div.innerHTML=`<b>${p.name}</b> <button onclick="drivers.splice(${i},1);renderDrivers()">âŒ</button>
    <button onclick="p.unavail.push({from:'00:00',to:'00:00'});renderDrivers()">+ Indispo</button>`;
    p.unavail.forEach((u,j)=>{
      div.innerHTML+=`<br>De <input type="time" value="${u.from}" onchange="drivers[${i}].unavail[${j}].from=this.value">
      Ã  <input type="time" value="${u.to}" onchange="drivers[${i}].unavail[${j}].to=this.value}">
      <button onclick="drivers[${i}].unavail.splice(${j},1);renderDrivers()">âŒ</button>`;
    });
    d.appendChild(div);
  });
}

function parseTime(t){let[a,b]=t.split(":").map(Number);return a*60+b;}
function fmt(m){m=(m%1440+1440)%1440;return String(Math.floor(m/60)).padStart(2,"0")+":"+String(m%60).padStart(2,"0");}

function available(p,s,e){
  for(let u of p.unavail){
    let a=parseTime(u.from), b=parseTime(u.to);
    let ss=s, ee=e; if(ee<ss) ee+=1440;
    let ranges=[];
    if(a<b){ranges.push([a,b]);ranges.push([a+1440,b+1440]);}
    else if(a>b){ranges.push([a,b+1440]);}
    else return false;
    for(let r of ranges){
      if(ss<r[1] && r[0]<ee) return false;
    }
  }
  return true;
}

function generatePlan(){
  if(drivers.length==0) return alert("Ajoute des pilotes");
  let [sh,sm]=$("startTime").value.split(":").map(Number);
  let start=sh*60+sm;
  let raceH=+$("raceHours").value;
  let fuelCap=+$("fuelCap").value;
  let fuelLap=+$("fuelLap").value;
  let [lm,ls]=$("lapTime").value.split(":").map(Number);
  let lapSec=lm*60+ls;
  let pit=$("pitSec").value/60;
  let laps=Math.floor(fuelCap/fuelLap);
  let stintMin=laps*lapSec/60;

  $("info").textContent=`Relais = ${laps} tours â‰ˆ ${Math.round(stintMin)} min`;

  plan=[];
  let t=start;
  let elapsed=0;
  let idx=0;
  let first=true;

  while(elapsed<raceH*60-0.1){
    if(!first){t+=pit; elapsed+=pit;}
    first=false;

    let p=drivers[idx];
    let rep=$("stintMode").value=="double"?2:1;

    for(let r=0;r<rep;r++){
      if(elapsed>=raceH*60) break;
      plan.push({start:t,end:t+stintMin,driver:p.name,laps:laps});
      t+=stintMin; elapsed+=stintMin;
      if(r<rep-1){t+=pit; elapsed+=pit;}
    }
    idx=(idx+1)%drivers.length;
  }

  renderPlan(); checkRules();
}

function renderPlan(){
  let tb=$("planTable"); tb.innerHTML="";
  plan.forEach((r,i)=>{
    let tr=document.createElement("tr");
    let p=drivers.find(d=>d.name==r.driver);
    if(p && !available(p,r.start,r.end)) tr.classList.add("bad");
    tr.innerHTML=`<td>${fmt(r.start)}</td><td>${fmt(r.end)}</td><td>${r.driver}</td><td>${r.laps}</td>
    <td><button onclick="openPilot(${i})">ğŸ”</button></td>`;
    tb.appendChild(tr);
  });
}

function openPilot(i){
  editIndex=i;
  let d=$("pilotButtons"); d.innerHTML="";
  drivers.forEach(p=>{
    let b=document.createElement("button");
    b.textContent=p.name;
    b.onclick=()=>{
      let r=plan[editIndex];
      if(!available(p,r.start,r.end)){
        if(!confirm("Pilote indisponible sur ce crÃ©neau. Forcer ?")) return;
      }
      r.driver=p.name;
      closePilot(); renderPlan(); checkRules();
    };
    d.appendChild(b);
  });
  $("pilotPopup").style.display="flex";
}
function closePilot(){$("pilotPopup").style.display="none";}

function checkRules(){
  let c=$("checks"); c.innerHTML="";
  let count={}; drivers.forEach(d=>count[d.name]=0);
  plan.forEach(r=>count[r.driver]+=r.laps);

  let raceH=+$("raceHours").value;
  let [lm,ls]=$("lapTime").value.split(":").map(Number);
  let lapSec=lm*60+ls;
  let total=Math.floor((raceH*3600)/lapSec);
  let min=Math.floor(total/drivers.length/4);

  drivers.forEach(d=>{
    let ok=count[d.name]>=min;
    let div=document.createElement("div");
    div.textContent=`${d.name} : ${count[d.name]} tours (min ${min})`;
    div.style.color=ok?"lightgreen":"red";
    c.appendChild(div);
  });
}

function openSave(){ refreshSaveList(); $("savePopup").style.display="flex"; }
function closeSave(){ $("savePopup").style.display="none"; }

function savePlan(){
  let name=$("saveName").value.trim();
  if(!name) return alert("Nom requis");
  let data={drivers,plan,settings:{
    startTime:$("startTime").value,
    raceHours:$("raceHours").value,
    stintMode:$("stintMode").value,
    fuelCap:$("fuelCap").value,
    fuelLap:$("fuelLap").value,
    lapTime:$("lapTime").value,
    pitSec:$("pitSec").value
  }};
  localStorage.setItem("plan_"+name, JSON.stringify(data));
  alert("Sauvegarde rÃ©ussie");
  refreshSaveList();
}

function loadPlan(name){
  let data=JSON.parse(localStorage.getItem("plan_"+name));
  drivers=data.drivers; plan=data.plan;
  let s=data.settings;
  $("startTime").value=s.startTime;
  $("raceHours").value=s.raceHours;
  $("stintMode").value=s.stintMode;
  $("fuelCap").value=s.fuelCap;
  $("fuelLap").value=s.fuelLap;
  $("lapTime").value=s.lapTime;
  $("pitSec").value=s.pitSec;
  renderDrivers(); renderPlan(); checkRules();
  alert("Planning chargÃ©");
}

function deletePlan(name){
  if(confirm("Supprimer "+name+" ?")){
    localStorage.removeItem("plan_"+name);
    refreshSaveList();
  }
}

function refreshSaveList(){
  let d=$("saveList"); d.innerHTML="";
  let keys=Object.keys(localStorage);
  keys.forEach(k=>{
    if(k.startsWith("plan_")){
      let n=k.replace("plan_","");
      let div=document.createElement("div");
      div.innerHTML=`<b>${n}</b>
      <button onclick="loadPlan('${n}')">ğŸ“‚</button>
      <button onclick="deletePlan('${n}')">ğŸ—‘ï¸</button>`;
      d.appendChild(div);
    }
  });
  if(d.innerHTML=="") d.innerHTML="<i>Aucune sauvegarde</i>";
}
</script>
</body>
</html>
