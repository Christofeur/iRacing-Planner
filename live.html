<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ascendia Racing - Live Manager</title>
<link rel="stylesheet" href="ascendia.css">
</head>
<body>

<div id="topBar">
  <div class="teamBrand">
    <img src="logo.png" alt="Ascendia Racing" class="teamLogo">
    <span class="teamName">Ascendia Racing</span>
  </div>
</div>

<!-- TOP RIGHT NAV (IDENTIQUE PLANNER) -->
<div class="topNav">
  <button onclick="location.href='index.html'">üè† Accueil</button>
  <button onclick="location.href='planner.html'">üõ† Planner</button>
  <button onclick="location.href='export.html'">üì§ Export</button>
  <button id="undoBtn" onclick="undoReplan()" disabled>‚Ü©Ô∏è Annuler le dernier recalcul</button>
</div>

<h1 class="mainTitle">üü¢ Live Manager</h1>

<div class="appContainer">

  <!-- ================== COLONNE GAUCHE ================== -->
  <div id="leftPanel">

    <div class="block">
      <h2>Charger un planning</h2>
      <select id="loadSelect"></select><br><br>
      <button onclick="loadPlan()">üìÇ Charger</button>
    </div>

  </div>

  <!-- ================== COLONNE DROITE ================== -->
  <div id="rightPanel">

    <h2 class="centerTitle" id="planTitle"></h2>

    <table class="planningTable">
      <thead>
        <tr>
          <th>#</th>
          <th>D√©but</th>
          <th>Fin</th>
          <th>Pilote</th>
          <th>Tours</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="planTable"></tbody>
    </table>

  </div>

</div>

<!-- POPUP INCIDENT -->
<div class="popupBG" id="incidentPopup">
  <div class="popup">
    <h3>üö® Incident</h3>
    <p>Heure r√©elle de sortie des stands :</p>
    <input type="time" id="incidentTime"><br><br>
    <button onclick="confirmIncident()">Recalculer</button>
    <button onclick="closeIncident()">Annuler</button>
  </div>
</div>

  <script>
function $(id){ return document.getElementById(id); }

// -------- Temps --------
function parseHM(t){
  let [h,m]=t.split(":").map(Number);
  return h*3600+m*60;
}
function fmt(sec){
  sec=((sec%86400)+86400)%86400;
  let h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

// -------- Donn√©es --------
let loadedData = null;
let workingPlan = null;
let previousPlan = null;
let incidentIndex = null;

let replannedFromIndex = null;
let previousReplannedFromIndex = null;

let raceEndTime = null; // FIN OFFICIELLE FIXE

// -------- Nettoyage STRICT du planning --------
function clampPlanToRaceEnd(){
  if(!workingPlan) return;

  let newPlan = [];

  for(let r of workingPlan){
    if(r.start >= raceEndTime) break;

    let start = r.start;
    let end = Math.min(r.end, raceEndTime);

    if(end <= start) break;

    newPlan.push({
      ...r,
      start: start,
      end: end
    });

    if(end >= raceEndTime) break;
  }

  workingPlan = newPlan;
}

// -------- Charger la liste des sauvegardes --------
function refreshLoadList(){
  let sel=$("loadSelect"); 
  sel.innerHTML="";
  Object.keys(localStorage)
    .filter(k=>k.startsWith("iracing_plan_"))
    .forEach(k=>{
      let n=k.replace("iracing_plan_","");
      let o=document.createElement("option");
      o.value=n; 
      o.textContent=n;
      sel.appendChild(o);
    });
}

// -------- Charger un planning --------
function loadPlan(){
  let n = $("loadSelect").value;
  if(!n) return alert("Aucune sauvegarde s√©lectionn√©e");

  let raw = localStorage.getItem("iracing_plan_"+n);
  if(!raw) return alert("Sauvegarde introuvable");

  loadedData = JSON.parse(raw);

  workingPlan = JSON.parse(JSON.stringify(loadedData.state.plan));

  let start = parseHM(loadedData.form.startTime);
  let raceHours = +loadedData.form.raceHours;
  raceEndTime = start + raceHours * 3600;

  previousPlan = null;
  replannedFromIndex = null;
  previousReplannedFromIndex = null;

  $("undoBtn").disabled = true;

  $("planTitle").textContent = 
    "Planning : " + n + " (fin course: " + fmt(raceEndTime) + ")";

  clampPlanToRaceEnd();
  renderPlan();
}

// -------- Affichage --------
function renderPlan(){
  let tb = $("planTable");
  tb.innerHTML = "";

  if(!workingPlan) return;

  workingPlan.forEach((r,i)=>{
    let tr = document.createElement("tr");

    let isReplanned = (replannedFromIndex !== null && i >= replannedFromIndex);
    if(isReplanned) tr.classList.add("replanned");

    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${fmt(r.start)}</td>
      <td>${fmt(r.end)}</td>
      <td>${r.driver} ${isReplanned ? '<span class="replannedIcon">üîÅ</span>' : ''}</td>
      <td>${r.laps}</td>
      <td><button onclick="openIncident(${i})">üö® Incident</button></td>
    `;
    tb.appendChild(tr);
  });
}

// -------- Incident --------
function openIncident(i){
  incidentIndex = i;
  $("incidentTime").value = "";
  $("incidentPopup").style.display = "flex";
}

function closeIncident(){
  $("incidentPopup").style.display = "none";
  incidentIndex = null;
}

function confirmIncident(){
  let t = $("incidentTime").value;
  if(!t) return alert("Entre une heure");

  let newStart = parseHM(t);
  applyReplan(incidentIndex, newStart);

  closeIncident();
}

// -------- REPLANIFICATION D√âFINITIVE --------
function applyReplan(index, newStartTime){
  if(!workingPlan || !loadedData) return;

  // Sauvegarde pour undo
  previousPlan = JSON.parse(JSON.stringify(workingPlan));
  previousReplannedFromIndex = replannedFromIndex;
  $("undoBtn").disabled = false;

  // On garde tout avant l'incident
  let before = workingPlan.slice(0, index);

  // S√©curit√© : ne pas repartir avant la fin du relais pr√©c√©dent
  if(before.length){
    let last = before[before.length - 1];
    if(newStartTime < last.end){
      newStartTime = last.end;
    }
  }

  // Si d√©j√† apr√®s la fin de course
  if(newStartTime >= raceEndTime){
    workingPlan = before;
    clampPlanToRaceEnd();
    replannedFromIndex = index;
    renderPlan();
    return;
  }

  // ===== BASE SAINE : PLAN ORIGINAL =====
  let originalPlan = loadedData.state.plan;

  // Dur√©e de relais de r√©f√©rence
  let ref = originalPlan[0];
  let stintDuration = ref.end - ref.start;
  let lapTimeSec = stintDuration / ref.laps;

  // ===== ROTATION COMPL√àTE DES PILOTES =====
  let drivers = originalPlan.map(r => r.driver);
  let startIdx = index % drivers.length;

  // ===== RECONSTRUCTION JUSQU'√Ä FIN =====
  let newPart = [];
  let t = newStartTime;
  let i = 0;

  while(t < raceEndTime){
    let driver = drivers[(startIdx + i) % drivers.length];

    let start = t;
    let end = Math.min(start + stintDuration, raceEndTime);

    let realDuration = end - start;
    if(realDuration <= 0) break;

    let realLaps = Math.floor(realDuration / lapTimeSec);

    newPart.push({
      start: start,
      end: end,
      driver: driver,
      laps: realLaps
    });

    if(end >= raceEndTime) break;

    t = end;
    i++;
  }

  // Nouveau planning
  workingPlan = before.concat(newPart);

  // S√©curit√© finale
  clampPlanToRaceEnd();

  replannedFromIndex = index;

  renderPlan();
}

// -------- Annuler --------
function undoReplan(){
  if(!previousPlan) return;

  workingPlan = JSON.parse(JSON.stringify(previousPlan));
  replannedFromIndex = previousReplannedFromIndex;

  previousPlan = null;
  previousReplannedFromIndex = null;

  $("undoBtn").disabled = true;

  clampPlanToRaceEnd();
  renderPlan();
}

// -------- INIT --------
refreshLoadList();
</script>



</body>
</html>
