<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>iRacing Live Manager</title>
<style>
body { font-family: Arial, sans-serif; padding:20px; background:#111; color:#eee; }
select, button, input { padding:5px; margin:5px; }

table { border-collapse: collapse; margin-top:20px; }
td, th { border:1px solid #555; padding:6px; }
.block { border:1px solid #444; padding:10px; margin-bottom:10px; }

.topbar { margin-bottom: 15px; }

.replanned {
  background: #1f3550;
}

.replannedIcon {
  margin-left: 6px;
  color: #7fb7ff;
  font-weight: bold;
}

/* Popup */
.popupBG {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
}
.popup {
  background: #222;
  padding: 20px;
  border-radius: 10px;
}
</style>
</head>
<body>

<div class="topbar">
  <button onclick="window.location.href='index.html'">ğŸ  Accueil</button>
</div>

<h1>ğŸ® Live Manager</h1>

<div class="block">
  <h2>Charger un planning</h2>
  <select id="loadSelect"></select>
  <button onclick="loadPlan()">ğŸ“‚ Charger</button>
</div>

<h2 id="planTitle"></h2>

<table>
<thead>
<tr>
  <th>#</th>
  <th>DÃ©but</th>
  <th>Fin</th>
  <th>Pilote</th>
  <th>Tours</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="planTable"></tbody>
</table>

<!-- POPUP INCIDENT -->
<div class="popupBG" id="incidentPopup">
  <div class="popup">
    <h3>ğŸš¨ Incident</h3>
    <p>Heure rÃ©elle de sortie des stands :</p>
    <input type="time" id="incidentTime">
    <br><br>
    <button onclick="confirmIncident()">Recalculer Ã  partir d'ici</button>
    <button onclick="closeIncident()">Annuler</button>
  </div>
</div>

<script>
function $(id){ return document.getElementById(id); }

// -------- Temps --------
function parseHM(t){
  let [h,m]=t.split(":").map(Number);
  return h*3600+m*60;
}
function fmt(sec){
  sec=((sec%86400)+86400)%86400;
  let h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

// -------- DonnÃ©es --------
let loadedData = null;
let workingPlan = null;   // planning live modifiable
let incidentIndex = null;
let replannedFromIndex = null; // Ã  partir de quel index on marque comme recalculÃ©

// -------- Charger la liste des sauvegardes --------
function refreshLoadList(){
  let sel=$("loadSelect"); sel.innerHTML="";
  Object.keys(localStorage)
    .filter(k=>k.startsWith("iracing_plan_"))
    .forEach(k=>{
      let n=k.replace("iracing_plan_","");
      let o=document.createElement("option");
      o.value=n; o.textContent=n;
      sel.appendChild(o);
    });
}

// -------- Charger un planning --------
function loadPlan(){
  let n = $("loadSelect").value;
  if(!n) return alert("Aucune sauvegarde sÃ©lectionnÃ©e");

  let raw = localStorage.getItem("iracing_plan_"+n);
  if(!raw) return alert("Sauvegarde introuvable");

  loadedData = JSON.parse(raw);

  // COPIE de travail
  workingPlan = JSON.parse(JSON.stringify(loadedData.state.plan));

  replannedFromIndex = null;

  $("planTitle").textContent = "Planning : " + n;

  renderPlan();
}

// -------- Affichage --------
function renderPlan(){
  let tb = $("planTable");
  tb.innerHTML = "";

  if(!workingPlan) return;

  workingPlan.forEach((r,i)=>{
    let tr = document.createElement("tr");

    let isReplanned = (replannedFromIndex !== null && i >= replannedFromIndex);
    if(isReplanned) tr.classList.add("replanned");

    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${fmt(r.start)}</td>
      <td>${fmt(r.end)}</td>
      <td>${r.driver} ${isReplanned ? '<span class="replannedIcon">ğŸ”</span>' : ''}</td>
      <td>${r.laps}</td>
      <td><button onclick="openIncident(${i})">ğŸš¨ Incident</button></td>
    `;
    tb.appendChild(tr);
  });
}

// -------- Incident --------
function openIncident(i){
  incidentIndex = i;
  $("incidentTime").value = "";
  $("incidentPopup").style.display = "flex";
}

function closeIncident(){
  $("incidentPopup").style.display = "none";
  incidentIndex = null;
}

function confirmIncident(){
  let t = $("incidentTime").value;
  if(!t) return alert("Entre une heure");

  let newStart = parseHM(t);

  applyReplan(incidentIndex, newStart);

  closeIncident();
}

// -------- Replanification --------
function applyReplan(index, newStartTime){
  // On garde tout avant l'incident
  let before = workingPlan.slice(0, index);

  // Infos depuis la sauvegarde
  let originalPlan = loadedData.state.plan;
  let form = loadedData.form;

  // DurÃ©e d'un relais (on suppose constant)
  let first = originalPlan[0];
  let stintDuration = first.end - first.start;

  let pitSec = +form.pitSec || 0;

  // Ordre des pilotes Ã  partir de l'index ORIGINAL
  let driversOrder = [];
  for(let i=index;i<originalPlan.length;i++){
    driversOrder.push(originalPlan[i].driver);
  }

  // Reconstruction
  let newPart = [];
  let t = newStartTime;

  for(let i=0;i<driversOrder.length;i++){
    let driver = driversOrder[i];

    let start = t;
    let end = start + stintDuration;

    newPart.push({
      start: start,
      end: end,
      driver: driver,
      laps: originalPlan[index].laps
    });

    // pit avant relais suivant
    t = end + pitSec;
  }

  // Nouveau planning live
  workingPlan = before.concat(newPart);

  // On marque Ã  partir d'oÃ¹ c'est recalculÃ©
  replannedFromIndex = index;

  renderPlan();
}

// init
refreshLoadList();
</script>

</body>
</html>
