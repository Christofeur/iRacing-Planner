<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Ascendia Racing - Live Manager</title>
<link rel="stylesheet" href="ascendia.css">
</head>
<body>

<!-- ================= TOP BAR ================= -->
<div id="topBar">
  <div class="teamBrand">
    <img src="logo.png" alt="Ascendia Racing" class="teamLogo">
    <span class="teamName">Ascendia Racing</span>
  </div>
</div>

<!-- ================= TOP NAV ================= -->
<div class="topNav">
  <button onclick="location.href='index.html'">ğŸ  Accueil</button>
  <button onclick="location.href='planner.html'">ğŸ›  Planner</button>
  <button onclick="location.href='export.html'">ğŸ“¤ Export</button>
</div>

<h1 class="mainTitle">ğŸŸ¢ Live Manager</h1>

<div class="appContainer">

  <!-- ===== LEFT PANEL ===== -->
  <div id="leftPanel">

    <div class="block">
      <h2>Charger un planning</h2>
      <select id="loadSelect"></select><br><br>
      <button onclick="loadPlan()">ğŸ“‚ Charger</button>
    </div>

    <div class="block">
      <h2>Actions</h2>
      <button id="undoBtn" onclick="undoReplan()" disabled>â†©ï¸ Annuler derniÃ¨re modif</button>
    </div>

  </div>

  <!-- ===== RIGHT PANEL ===== -->
  <div id="rightPanel">

    <h2 id="planTitle" class="centerTitle"></h2>

    <table class="planningTable">
      <thead>
        <tr>
          <th>#</th>
          <th>DÃ©but</th>
          <th>Fin</th>
          <th>Pilote</th>
          <th>Tours</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="planTable"></tbody>
    </table>

  </div>

</div>

<!-- ================= POPUP INCIDENT ================= -->
<div class="popupBG" id="incidentPopup">
  <div class="popup">
    <h2>ğŸš¨ Incident</h2>

    <div>
      <label>Heure de sortie des stands :</label><br>
      <input type="time" id="incidentTime">
    </div>

    <br>

    <div>
      <label>Pilote qui repart :</label><br>
      <select id="incidentDriver"></select>
    </div>

    <br>

    <button onclick="confirmIncident()">âœ… Appliquer</button>
    <button onclick="closeIncident()">âŒ Annuler</button>
  </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
function $(id){ return document.getElementById(id); }

// -------- Temps --------
function parseHM(t){ let [h,m]=t.split(":").map(Number); return h*3600+m*60; }
function fmt(sec){
  sec=((sec%86400)+86400)%86400;
  let h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60);
  return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
}

// -------- DonnÃ©es --------
let loadedData=null, workingPlan=null, previousPlan=null;
let incidentIndex=null;
let replannedFromIndex=null, previousReplannedFromIndex=null;
let raceEndTime=null;

// -------- Clamp --------
function clampPlanToRaceEnd(){
  if(!workingPlan) return;
  let newPlan=[];
  for(let r of workingPlan){
    if(r.start>=raceEndTime) break;
    let end=Math.min(r.end,raceEndTime);
    if(end<=r.start) break;
    newPlan.push({...r,end:end});
    if(end>=raceEndTime) break;
  }
  workingPlan=newPlan;
}

// -------- Load list --------
function refreshLoadList(){
  let sel=$("loadSelect"); sel.innerHTML="";
  Object.keys(localStorage).filter(k=>k.startsWith("iracing_plan_")).forEach(k=>{
    let n=k.replace("iracing_plan_","");
    let o=document.createElement("option");
    o.value=n; o.textContent=n;
    sel.appendChild(o);
  });
}

// -------- Load plan --------
function loadPlan(){
  let n=$("loadSelect").value;
  if(!n) return alert("Aucune sauvegarde");

  loadedData=JSON.parse(localStorage.getItem("iracing_plan_"+n));
  workingPlan=JSON.parse(JSON.stringify(loadedData.state.plan));

  let start=parseHM(loadedData.form.startTime);
  raceEndTime=start+(+loadedData.form.raceHours)*3600;

  previousPlan=null; replannedFromIndex=null;
  $("undoBtn").disabled=true;

  $("planTitle").textContent="Planning : "+n+" (fin: "+fmt(raceEndTime)+")";

  clampPlanToRaceEnd();
  renderPlan();
}

// -------- Render --------
function renderPlan(){
  let tb=$("planTable"); tb.innerHTML="";
  if(!workingPlan) return;

  workingPlan.forEach((r,i)=>{
    let tr=document.createElement("tr");
    let repl=(replannedFromIndex!==null && i>=replannedFromIndex);
    if(repl) tr.classList.add("replanned");
    tr.innerHTML=`
      <td>${i+1}</td>
      <td>${fmt(r.start)}</td>
      <td>${fmt(r.end)}</td>
      <td>${r.driver} ${repl?'ğŸ”':''}</td>
      <td>${r.laps}</td>
      <td><button onclick="openIncident(${i})">ğŸš¨ Incident</button></td>
    `;
    tb.appendChild(tr);
  });
}

// -------- Incident --------
function openIncident(i){
  incidentIndex=i;
  $("incidentTime").value="";
  let sel=$("incidentDriver"); sel.innerHTML="";

  let drivers=[];
  loadedData.state.plan.forEach(r=>{ if(!drivers.includes(r.driver)) drivers.push(r.driver); });

  drivers.forEach(d=>{
    let o=document.createElement("option");
    o.value=d; o.textContent=d;
    sel.appendChild(o);
  });

  sel.value=workingPlan[i].driver;
  $("incidentPopup").style.display="flex";
}
function closeIncident(){ $("incidentPopup").style.display="none"; }
function confirmIncident(){
  let t=$("incidentTime").value;
  if(!t) return alert("Heure manquante");
  applyReplan(incidentIndex, parseHM(t), $("incidentDriver").value);
  closeIncident();
}

// -------- Replan --------
function applyReplan(index,newStartTime,forcedDriver){
  previousPlan=JSON.parse(JSON.stringify(workingPlan));
  $("undoBtn").disabled=false;

  let before=workingPlan.slice(0,index);
  if(before.length && newStartTime<before.at(-1).end) newStartTime=before.at(-1).end;

  let originalPlan=loadedData.state.plan;
  let ref=originalPlan[0];
  let stintDuration=ref.end-ref.start;
  let lapTimeSec=stintDuration/ref.laps;

  let drivers=[];
  originalPlan.forEach(r=>{ if(!drivers.includes(r.driver)) drivers.push(r.driver); });

  let startDriver=forcedDriver;
  let startIdx=drivers.indexOf(startDriver); if(startIdx<0) startIdx=0;

  let newPart=[], t=newStartTime, i=0;
  while(t<raceEndTime){
    let driver=drivers[(startIdx+i)%drivers.length];
    let end=Math.min(t+stintDuration,raceEndTime);
    let laps=Math.floor((end-t)/lapTimeSec);
    newPart.push({start:t,end:end,driver:driver,laps:laps});
    if(end>=raceEndTime) break;
    t=end; i++;
  }

  workingPlan=before.concat(newPart);
  clampPlanToRaceEnd();
  replannedFromIndex=index;
  renderPlan();
}

// -------- Undo --------
function undoReplan(){
  if(!previousPlan) return;
  workingPlan=JSON.parse(JSON.stringify(previousPlan));
  previousPlan=null;
  replannedFromIndex=null;
  $("undoBtn").disabled=true;
  clampPlanToRaceEnd();
  renderPlan();
}

// -------- INIT --------
refreshLoadList();
</script>

</body>
</html>
